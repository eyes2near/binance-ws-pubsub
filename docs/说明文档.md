# 项目说明文档

## 1. 项目概述

`binance-ws-pubsub` 是一个基于Go语言实现的发布-订阅（Pub/Sub）系统，专门用于获取、处理和展示币安（Binance）交易所的实时订单簿（Order Book）数据。

项目采用清晰的三层架构，将数据获取、消息路由和数据显示分离，实现了高度的解耦和可扩展性。

- **发布者 (Publisher)**：连接到币安的WebSocket API，维护一个完整的本地订单簿，并将其聚合成关键价位的快照数据后发布出去。
- **代理 (Broker)**：一个通用的WebSocket消息中间件，负责接收发布者的消息并将其转发给所有订阅者。
- **订阅者 (Subscriber)**：连接到代理，订阅感兴趣的数据，并在终端中以实时、清晰的表格形式展示订单簿快照。

## 2. 功能特性

- **实时性**：通过WebSocket直连币安，保证数据延迟最低。
- **高性能**：Go语言原生支持高并发，能够高效处理海量市场事件。
- **架构清晰**：发布者、订阅者、代理各司其职，易于理解和维护。
- **关注点分离**：
    - **发布者**承担了所有繁重的业务逻辑（API对接、数据校验、订单簿维护、数据聚合）。
    - **订阅者**是一个纯粹的“哑”终端，只负责展示，无需处理复杂逻辑。
- **良好兼容性**：同时支持币安 **现货 (Spot)** 和 **U本位/币本位合约 (Futures)** 市场。
- **优化的终端UI**：订阅者使用ANSI转义码在终端内实现原地刷新，提供了类似`top`命令的流畅、无闪烁的视觉体验。

## 3. 架构设计

系统的数据流向非常清晰：

```
+--------------+     +-------------+     +----------------+     +--------------+
| Binance API  | --> |  Publisher  | --> |     Broker     | --> |  Subscriber  |
+--------------+     +-------------+     +----------------+     +--------------+
       ^                   |                     ^                    |
       |                   |                     |                    |
(WebSocket Stream)   (发布聚合数据)      (WebSocket连接)     (在终端UI中展示)
```

1.  **Publisher** 首先通过REST API从币安获取指定交易对的订单簿快照进行初始化。
2.  随后，**Publisher** 订阅该交易对的WebSocket深度事件流，实时更新本地维护的完整订单簿。
3.  **Publisher** 将完整的订单簿数据聚合成一个围绕中间价的“价格档位快照”（`BandSnapshot`），这是一种预处理过的数据，只包含最重要的挂单信息。
4.  **Publisher** 将这个快照数据发布到 **Broker** 的一个特定主题（Topic）上，例如 `orderbook.band.BNBBTC`。
5.  **Subscriber** 启动后，连接到 **Broker** 并发送订阅请求，指明其感兴趣的主题。
6.  当 **Broker** 收到来自 **Publisher** 的消息时，会将其广播给所有订阅了该主题的 **Subscriber**。
7.  **Subscriber** 接收到预处理好的快照数据后，直接将其格式化并在终端上渲染出来。

## 4. 如何构建

项目包含三个独立的可执行文件。你可以使用以下命令在项目根目录分别构建它们：

```bash
# 构建代理
go build -o broker.exe ./cmd/broker

# 构建发布者
go build -o publisher.exe ./cmd/publisher

# 构建订阅者
go build -o subscriber.exe ./cmd/subscriber
```

## 5. 如何运行

必须按照“代理 -> 发布者 -> 订阅者”的顺序启动。

### 第1步：启动代理

代理默认在 `8080` 端口上监听WebSocket连接。

```bash
./broker.exe
```

### 第2步：启动发布者

发布者需要通过命令行参数指定要连接的市场和交易对。

-   `-market`: 市场类型，`spot` (现货), `cm` (币本位合约), `um` (U本位合约)。
-   `-symbol`: 交易对，例如 `BNBUSDT`, `BTCUSDT`。

**示例：**
```bash
# 订阅币安现货市场的 BNBBTC 交易对
./publisher.exe -market spot -symbol BNBBTC

# 订阅币安U本位合约的 BTCUSDT 交易对
./publisher.exe -market um -symbol BTCUSDT
```
发布者会将数据发布到格式为 `orderbook.band.<SYMBOL>` 的主题。

### 第3步：启动订阅者

订阅者需要指定要从代理订阅的主题。

-   `-topic`: 要订阅的主题名。

**示例：**
```bash
# 订阅上面发布的 BNBBTC 现货数据
./subscriber.exe -topic orderbook.band.BNBBTC

# 订阅上面发布的 BTCUSDT 合约数据
./subscriber.exe -topic orderbook.band.BTCUSDT
```
成功运行后，你的终端将显示一个实时更新的订单簿表格。

## 6. 代码结构

```
.
├── cmd/                # 主程序入口
│   ├── broker/         # 代理程序
│   ├── publisher/      # 发布者程序
│   └── subscriber/     # 订阅者程序
├── internal/           # 项目内部共享代码
│   ├── binance/        # 币安API相关数据结构和请求逻辑
│   ├── broker/         # 代理的核心实现
│   └── orderbook/      # 本地订单簿维护和数据聚合逻辑
├── go.mod
└── README.md
```

-   **`cmd/`**: 存放三个主要应用（`broker`, `publisher`, `subscriber`）的 `main` 包。每个子目录都是一个独立的可执行程序的入口点。
-   **`internal/`**: 存放项目内部的业务逻辑代码，外部无法直接导入。
    -   **`binance/`**: 定义了与币安API交互（REST和WebSocket）所需的数据结构。
    -   **`broker/`**: 实现了代理服务器的核心功能，包括客户端管理、主题订阅和消息广播。
    -   **`orderbook/`**: 实现了最核心的业务逻辑——在本地内存中维护一个完整的、与交易所同步的订单簿，并能根据规则应用更新和生成聚合快照。
```